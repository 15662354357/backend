# 登录功能测试指南

## 1. 确认数据库已初始化

首先确保数据库已经创建并执行了初始化脚本：

```sql
-- 连接到 MySQL
mysql -u root -p

-- 选择数据库
USE finance_kb;

-- 检查用户表是否有数据
SELECT * FROM sys_user;

-- 应该看到默认管理员：
-- username: admin
-- password: $2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iKyZHl5X6hKVNXqZ8LlOZqs5pD4K (BCrypt加密后的admin123)
```

如果没有数据，执行数据库脚本：

```bash
mysql -u root -p < backend/src/main/resources/db/schema.sql
```

## 2. 测试方法

### 方法一：使用 curl 命令（推荐）

#### 2.1 测试登录接口

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

**预期响应**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": "eyJhbGciOiJIUzI1NiJ9...",
  "timestamp": 1699000000000
}
```

**成功后会返回 JWT Token**，保存这个 Token 用于后续请求。

#### 2.2 测试注册接口

```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "email": "test@example.com",
    "nickname": "测试用户"
  }'
```

#### 2.3 测试获取用户信息（需要Token）

```bash
curl -X GET http://localhost:8080/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

将 `YOUR_TOKEN_HERE` 替换为登录时返回的 Token。

### 方法二：使用 Postman

#### 2.1 测试登录

1. **创建新请求**
   - 方法：POST
   - URL：`http://localhost:8080/api/auth/login`
   - Headers：
     ```
     Content-Type: application/json
     ```

2. **Body（选择 raw - JSON）**
   ```json
   {
     "username": "admin",
     "password": "admin123"
   }
   ```

3. **发送请求**
   - 查看响应，应该返回 200 状态码和 Token

4. **保存 Token**
   - 复制响应中的 `data` 字段值（这是 JWT Token）
   - 在后续需要认证的请求中使用

#### 2.2 测试获取用户信息

1. **创建新请求**
   - 方法：GET
   - URL：`http://localhost:8080/api/user/info`
   - Headers：
     ```
     Authorization: Bearer YOUR_TOKEN_HERE
     ```
     将 `YOUR_TOKEN_HERE` 替换为登录返回的 Token

2. **发送请求**
   - 应该返回用户信息

### 方法三：使用前端测试

1. 启动前端项目：
   ```bash
   cd frontend
   npm install
   npm run dev
   ```

2. 访问 `http://localhost:3000`

3. 使用默认管理员账号登录：
   - 用户名：`admin`
   - 密码：`admin123`

## 3. 默认测试账号

根据数据库脚本，默认管理员账号：
- **用户名**：`admin`
- **密码**：`admin123`
- **邮箱**：`admin@example.com`

## 4. 常见问题排查

### 问题1：登录失败，提示用户名或密码错误

**检查步骤**：
1. 确认数据库中存在该用户：
   ```sql
   SELECT * FROM sys_user WHERE username = 'admin';
   ```

2. 如果数据库中密码不正确，可以手动重新生成 BCrypt 密码：
   - 使用在线 BCrypt 工具：https://bcrypt-generator.com/
   - 或者使用 Java 代码生成（见下文）

3. 更新数据库中的密码：
   ```sql
   UPDATE sys_user 
   SET password = '$2a$10$重新生成的BCrypt密码' 
   WHERE username = 'admin';
   ```

### 问题2：Token 无效或过期

- Token 默认有效期为 24 小时
- 如果 Token 过期，需要重新登录获取新 Token

### 问题3：401 未授权错误

- 检查请求头中是否包含 `Authorization: Bearer YOUR_TOKEN`
- 检查 Token 是否过期
- 检查 Token 格式是否正确

### 问题4：数据库连接失败

- 检查 MySQL 是否启动
- 检查 `application.yml` 中的数据库配置是否正确
- 检查数据库 `finance_kb` 是否已创建

## 5. 测试用例

### 测试用例1：正常登录
- **输入**：正确的用户名和密码
- **预期**：返回 200，包含 Token

### 测试用例2：错误密码
- **输入**：正确的用户名，错误的密码
- **预期**：返回 500，提示"密码错误"

### 测试用例3：不存在的用户
- **输入**：不存在的用户名
- **预期**：返回 500，提示"用户不存在"

### 测试用例4：空参数
- **输入**：空用户名或密码
- **预期**：返回 400，提示"参数验证失败"

### 测试用例5：Token 认证
- **输入**：有效的 Token
- **预期**：返回用户信息
- **输入**：无效的 Token
- **预期**：返回 401，提示"未授权"

## 6. 快速测试脚本

创建一个测试脚本 `test-login.sh`：

```bash
#!/bin/bash

# 测试登录
echo "=== 测试登录 ==="
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}')

echo "$LOGIN_RESPONSE" | jq .

# 提取 Token
TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data')

if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then
    echo ""
    echo "=== 登录成功，Token: $TOKEN ==="
    echo ""
    
    # 测试获取用户信息
    echo "=== 测试获取用户信息 ==="
    curl -s -X GET http://localhost:8080/api/user/info \
      -H "Authorization: Bearer $TOKEN" | jq .
else
    echo "登录失败！"
fi
```

Windows 版本 `test-login.bat`：

```batch
@echo off
echo === 测试登录 ===
curl -X POST http://localhost:8080/api/auth/login -H "Content-Type: application/json" -d "{\"username\":\"admin\",\"password\":\"admin123\"}"

echo.
echo === 测试完成 ===
pause
```

## 7. 下一步

登录功能测试通过后，可以继续：
1. ✅ 文件上传功能
2. ✅ AI 对话功能
3. ✅ 知识库管理功能
4. ✅ 后台管理功能

